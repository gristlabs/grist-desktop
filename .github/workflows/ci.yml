name: CI
on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main
      - dev
    tags:
      - '*'

env:
  FORCE_COLOR: 1

jobs:
  test-windows-x86-sqlite3:
    runs-on: windows-2022
    name: Test Windows x86 sqlite3 build
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Submodule cleanup fix
        run: |
          git submodule foreach --recursive git clean -ffdx
          git submodule foreach --recursive git reset --hard

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: yarn install --network-timeout 300000 --ignore-optional

      - name: Test simplified Windows x86 sqlite3 build fix
        shell: bash
        run: |
          echo "=== Testing simplified approach based on package.yml ==="
          
          # Install global tools
          yarn global add node-gyp
          
          # Get proper yarn global bin path for Windows
          YARN_BIN_DIR=$(yarn global bin | sed 's/\r$//' | sed 's/\\/\//g')
          echo "Yarn global bin: $YARN_BIN_DIR"
          
          # Download Node.js headers for ia32 - this should fix the missing 'uv.h' error
          "$YARN_BIN_DIR/node-gyp" install --arch=ia32
          
          # Remove existing bindings to force rebuild
          rm -rf node_modules/@gristlabs/sqlite3/lib/binding/* || true
          
          # Rebuild sqlite3 from source
          yarn upgrade @gristlabs/sqlite3
          
          echo "=== Checking build result ==="
          if [ -f "node_modules/@gristlabs/sqlite3/lib/binding/napi-v6-win32-ia32/node_sqlite3.node" ]; then
            echo "✅ SUCCESS: Windows x86 sqlite3 build completed!"
            
            # Quick functionality test
            node -e "
              const sqlite3 = require('@gristlabs/sqlite3');
              console.log('✅ SQLite3 loaded successfully');
              console.log('Version:', sqlite3.VERSION);
            "
          else
            echo "❌ FAILED: Expected binary not found"
            echo "Available bindings:"
            ls -la "node_modules/@gristlabs/sqlite3/lib/binding/" || echo "No bindings directory"
            exit 1
          fi
        env:
          npm_config_build_from_source: true
          npm_config_target_arch: ia32
          npm_config_fallback_to_build: true
          npm_config_msvs_version: "2022"
