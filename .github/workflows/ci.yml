name: CI
on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main
      - dev
    tags:
      - '*'

env:
  FORCE_COLOR: 1

jobs:
  test-windows-x86-sqlite3:
    runs-on: windows-2022
    name: Test Windows x86 sqlite3 build
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Submodule cleanup fix
        run: |
          git submodule foreach --recursive git clean -ffdx
          git submodule foreach --recursive git reset --hard

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: yarn install --network-timeout 300000 --ignore-optional

      - name: Test comprehensive Windows x86 sqlite3 build fix with platform detection
        shell: bash
        run: |
          echo "=== Testing Windows x86 sqlite3 build with comprehensive platform detection ==="
          
          # Download Node.js headers for ia32 first
          npx node-gyp install --arch=ia32
          
          # Remove existing bindings to force rebuild
          rm -rf node_modules/@gristlabs/sqlite3/lib/binding/* || true
          
          # Direct rebuild with node-gyp in sqlite3 directory for proper platform detection
          cd node_modules/@gristlabs/sqlite3
          npx node-gyp rebuild --arch=ia32
          
          echo "=== Checking build result ==="
          cd ../../..
          
          echo "Checking for expected binary location:"
          if [ -f "node_modules/@gristlabs/sqlite3/lib/binding/napi-v6-win32-ia32/node_sqlite3.node" ]; then
            echo "✅ SUCCESS: Windows x86 sqlite3 build completed!"
            
            # Quick functionality test
            node -e "
              const sqlite3 = require('@gristlabs/sqlite3');
              console.log('✅ SQLite3 loaded successfully');
              console.log('Version:', sqlite3.VERSION);
            "
          else
            echo "❌ FAILED: Expected binary not found at napi-v6-win32-ia32"
            echo "Available bindings:"
            ls -la "node_modules/@gristlabs/sqlite3/lib/binding/" || echo "No bindings directory"
            
            # Check if it was built with unknown platform
            if [ -f "node_modules/@gristlabs/sqlite3/lib/binding/napi-v6-win32-unknown-ia32/node_sqlite3.node" ]; then
              echo "⚠️  Found binary with 'unknown' platform identifier"
              echo "This indicates platform detection is not working correctly"
            fi
            exit 1
          fi
        env:
          npm_config_build_from_source: true
          npm_config_target_arch: ia32
          npm_config_target_platform: win32
          npm_config_target_libc: msvcrt
          npm_config_fallback_to_build: true
          npm_config_msvs_version: "2022"
